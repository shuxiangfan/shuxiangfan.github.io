

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="摸鱼-躺平-划水">
  <meta name="author" content="libfsx">
  <meta name="keywords" content="摸鱼-躺平-划水">
  
  <title>Programming from the Ground Up notes - libfsx&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"shuxiangfan.github.io","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":"UA-205458257-1","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>libfsx的博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Programming from the Ground Up notes">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2025-08-18 22:09" pubdate>
        2025年8月18日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      45
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Programming from the Ground Up notes</h1>
            
            <div class="markdown-body">
              <p>本文是 Jonathan Bartlett 撰写的 <em>Programming from the Ground Up</em> 书的笔记</p>
<h1>Chapter 1 介绍</h1>
<h2 id="工具">工具</h2>
<p>本书讨论的是x86的汇编语言和 GNU/Linux 操作系统，所以我们会使用标准的 GCC 工具集。<br>
Tips：本书使用<strong>AT&amp;T</strong>语体</p>
<h1>Chapter 2 计算机架构</h1>
<p>现代计算机架构基于冯诺依曼架构，包括两个部分——<strong>CPU</strong>和<strong>内存</strong>。</p>
<h2 id="计算机内存的结构">计算机内存的结构</h2>
<p>存储在计算机的内存里面的不止是数据，还有控制计算机操作的程序。除了它们被使用的方式不同，它们都以相同的方式储存在内存中并以相同的方式访问。</p>
<h2 id="中央处理器（CPU）">中央处理器（CPU）</h2>
<p>CPU从内存中读取指令并执行它们。这被称为 <code>fetch-excute cycle</code><br>
为了实现这个，CPU包含：</p>
<ul>
<li>程序计数器（Program Counter）</li>
<li>指令解码器（Instruction Decoder）</li>
<li>数据总线（Data bus）</li>
<li>通用寄存器（General-purpose registers）</li>
<li>算术和逻辑单元（Arithmetic and logic unit）</li>
</ul>
<p>程序计数器告诉计算机该从哪里获取下一条指令。程序计数器保存着下一个该被执行的指令的内存地址。CPU通过程序计数器中储存的内存地址，将对应地址的指令传递给指令解码器。指令解码器将解码指令并指明该条指令有关的内存地址。计算机指令一般由实际的指令和一些内存地址组成。<br>
然后计算机用数据总线来获取待处理的内存位置。数据总线用来连接CPU和内存的物理连线，就像主板上的线那样。<br>
除了处理器外面的内存，处理器自己还有一些特殊的高速的内存位置，称作<strong>寄存器（registers）</strong>。有两种寄存器——<strong>通用寄存器（General-purpose registers）</strong> 和 <strong>专用寄存器（Special-purpose registers）</strong>。<br>
现在CPU已经获取到了它需要的所有数据，它将数据和已解码的指令传递给算术和逻辑单元来进行进一步处理。指令实际上就是在这里被执行的。在计算完成之后，结果被放在数据总线上并被储存到合适的内存位置或寄存器中。<br>
这是一个极度简化了的过程，事实上，现代计算机已经进步了很多， 以上的过程并未考虑缓存层次结构、超标量处理器、流水线、分支预测、乱序执行、微码转换、协处理器和其他优化。</p>
<h2 id="一些术语">一些术语</h2>
<p>计算机的内存是固定大小的有序的存储空间。每个存储位置对应的编号叫做它的 <strong>地址（address）</strong> 单个存储位置的大小叫做 <strong>字节（byte）</strong> 。在x86处理器上，一字节就是一个0到255的数。<br>
计算机可以使用ASCII来处理文字。<br>
如果我们需要表示比255大的数字怎么办？我们可以吧多个字节整合在一起，比如两个字节最大表示65535，四个字节最大可以表示4294967295。幸运的是，我们不必手动把字节捏在一起，事实上，计算机会帮我们处理细节。<strong>我们默认处理四字节长的数据</strong><br>
你可以把寄存器想象为你的桌子，上面保存着你要处理的数据。<br>
在计算机上，一个典型的寄存器的大小叫做一个电脑的<strong>字长（word size）</strong>。x86处理器的字长为四字节。这意味着四字节是在x86上处理的最自然的。地址也是四字节长的，所以它能塞进一个寄存器内，<br>
储存在内存中的地址也叫做<strong>指针（pointers）</strong>。它们指向一个不同的内存位置。<br>
正如我们前面提到的，计算机指令和数据以一致的方式储存着。区别他俩的唯一方式就是通过一个专用寄存器叫做指令指针，它指向内存中的指令。如果指令指针指向一个内存字，那么它就会被解释为指令。</p>
<h2 id="解读内存">解读内存</h2>
<p>计算机十分精确，所以你对你在操作什么东西必须十分明白。</p>
<h2 id="数据访问方法">数据访问方法</h2>
<p>处理器有很多访问数据的方法，称作<strong>寻址模式（addressing modes）</strong>  。<br>
最简单的寻址模式是<strong>立即模式（immediate mode）</strong>，数据直接内嵌在处理器中，比如我们要载入数字0，那么就可以指定立即模式直接写入0。<br>
<strong>寄存器寻址模式（register addressing mode）</strong>，指令包含一个要访问的寄存器，而不是一个内存地址。剩余的模式会处理内存地址。<br>
<strong>直接寻址模式（direct addressing mode）</strong>  ，指令包含着要访问的内存地址。计算机会直接从指定的内存地址获取数据。<br>
<strong>索引寻址模式（indexed addressing mode）</strong>，指令包含内存地址，并且还指定了一个 <strong>索引寄存器（index register）</strong> 来对那个地址进行 <strong>偏移（offset）</strong> 。比方说你指定了地址114510，偏移寄存器储存为4，那么你实际访问的地址就是114514。在x86处理器上，你还可以给索引寄存器指定一个 <strong>倍数（multiplier）</strong> 以便一次访问若干个字节的内存。<br>
<strong>间接寻址模式（indirect addressing mode）</strong> ，指令包含一个寄存器，里面储存着一个指针指向我们要访问的地方。比如<code>%eax</code>寄存器中储存着值4，那么在间接寻址模式下，我们就去内存地址为4的位置加载数据，而在直接寻址模式，我们直接载入4。<br>
最后，是 <strong>基指针寻址模式（base pointer addressing mode）</strong> 。和间接寻址模式相似，但是你还要加入偏移来向寄存器加上偏移值再访问数据。<br>
还有其他的寻址模式，在这里我们只介绍重要的几个。</p>
<h1>Chapter 3 你的第一个程序</h1>
<h2 id="输入一个程序">输入一个程序</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#exit.s: 一个简单的程序，退出并向内核返回一个状态码。<br>.section .data<br>.section .text #这一部分是指令<br>.global _start #表明_start符号（symbol）<br>                #符号通常用来标记程序或数据的位置，你可以用符号的名字而不是地址来引用它<br>                # .global表明汇编器不应该丢弃这个符号，因为链接器会需要<br>                #_start 应永远与.global 使用，否则电脑不知道从哪里开始执行你的程序<br>_start: #定义了_start标签（lable）的值<br>        #标签就是一个符号后面跟一个冒号<br>        #标签定义了符号的值<br>movl $1, %eax #系统调用编号，将数字1传入%eax寄存器<br>              #数字1前加$符号表示我们使用立即模式<br>movl $0, %ebx #返回的状态码，将数字0传入%ebx寄存器<br>int $0x80 #内核中断，int代表中断（interrupt）<br></code></pre></td></tr></table></figure>
<p>使用 <code>as exit.s -o exit.o</code> 和 <code>ld exit.o -o exit</code> 来汇编并链接。</p>
<h2 id="汇编语言小知识">汇编语言小知识</h2>
<p>中断就是中断正常的指令流，把控制权交给内核来完成 <strong>系统调用（system call）</strong> ，系统调用完成后再将控制权交回程序。<br>
<strong>系统调用快速回顾：</strong> 简而言之，系统的功能可以通过系统调用来访问。通过特别地设置寄存器并执行<code>int 0x80</code>指令，Linux 内核通过 <code>%eax</code> 寄存器的值知道我们要访问哪个系统调用，在上面的例子中，系统调用序号1就是<code>exit</code>调用，需要把状态码放在 <code>%ebx</code> 寄存器中。</p>
<p>在x86处理器上，有几个通用寄存器（都可以使用 <code>movl</code> 指令），包括：</p>
<ul>
<li><code>%eax</code></li>
<li><code>%ebx</code></li>
<li><code>%ecx</code></li>
<li><code>%edx</code></li>
<li><code>%edi</code></li>
<li><code>%esi</code></li>
</ul>
<p>还有专用寄存器，包括：</p>
<ul>
<li><code>%ebp</code></li>
<li><code>%esp</code></li>
<li><code>%eip</code></li>
<li><code>%eflags</code></li>
</ul>
<p>像 <code>%eip</code> 和 <code>%eflags</code> 这种只能通过特殊的指令访问。其他的寄存器可以像通用寄存器那样用普通的指令访问，但是他们有特殊的意义和用途。</p>
<h2 id="找到最大值">找到最大值</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># maximum.s: 找出一组数据的最大值<br># %edi储存着正在处理的数据的索引<br># %ebx储存着目前找到的最大的数据<br># %eax储存着目前的数据<br>.section .data<br><br>data_items: # 没有_global标志，我们只在程序内部使用它<br> .long 3,67,34,222,45,75,54,34,44,33,22,11,66,0<br><br>.section .text<br><br>.global _start<br><br>_start:<br> movl $0, %edi<br> movl data_items(,%edi,4),  %eax<br> movl %eax, %ebx<br><br>start_loop:<br> cmpl $0, %eax<br> je loop_exit<br> incl %edi<br> movl data_items(,%edi,4), %eax<br> cmpl %ebx, %eax<br> jle start_loop<br> movl %eax, %ebx<br> jmp start_loop<br><br>loop_exit:<br> movl $1, %eax<br> int 0x80<br></code></pre></td></tr></table></figure>
<p>通过 <code>echo $?</code> 来获得运行结果<br>
第八行的 <code>.long</code> 表示保留的内存位置的类型，有：</p>
<ul>
<li><code>.byte</code>:占据一个存储位置，0-255</li>
<li><code>.int</code>：占据两个存储位置，0-65535</li>
<li><code>.long</code>：占据四个存储位置，0-4294967295</li>
<li><code>.ascii</code>：在内存中储存字符串，如 <code>.ascii &quot;Hello there\0&quot;</code> 就会以ascii码的形式在内存中储存12个字节，其中 <code>\0</code> 表示字符串的终止，不会显示在屏幕上。</li>
</ul>
<p>第十六行的 <code>movl data_items(,%edi,4)</code> 表示从data_items开始，以 <code>%edi</code> 为索引，一次获取四个字节的数据并将其储存在 <code>%eax</code> 寄存器中。索引寻址模式更一般的形式是：<br>
<code>movl 开始的地址(,%索引寄存器,字长)</code><br>
下一个 <code>cmpl</code> 指令是比较两个值，影响到 <code>%eflags</code> 寄存器，也称作状态寄存器。紧接着的是流控制指令 <code>je</code> ，它使用状态寄存器来获取上一次比较的结果，还有很多跳转指令：</p>
<ul>
<li><code>je</code> 如果相等就跳转</li>
<li><code>jg</code> 如果第二个比较的值比第一个大就跳转</li>
<li><code>jge</code> 如果第二个比较的值大于等于第一个就跳转</li>
<li><code>jl</code> 如果第二个比较的值小于第一个就跳转</li>
<li><code>jle</code> 如果第二个比较的值小于等于第一个就跳</li>
<li><code>jmp</code> 无论情况如何，直接跳转</li>
</ul>
<p><code>incl %edi</code> 表示将 <code>%edi</code> 加1</p>
<h2 id="寻址模式">寻址模式</h2>
<p>通用的内存地址引用是：<br>
<code>地址或偏移(%基准或偏移,%索引,倍数)</code><br>
<code>最终地址 = 地址或偏移 + %基准或偏移 + 倍数 * %索引</code></p>
<h3 id="直接寻址模式">直接寻址模式</h3>
<p>只使用地址或偏移部分，例如 <code>movl ADDRESS, %eax</code> 将在ADDRESS内存地址的值载入 <code>%eax</code> 寄存器</p>
<h3 id="索引寻址模式">索引寻址模式</h3>
<p>例如 <code>movl string_start(,%ecx,1), %eax</code> 从 <code>string_start</code> 开始，再加上 <code>1*%ecx</code> ，将最终的值载入<code>%eax</code></p>
<h3 id="间接寻址模式">间接寻址模式</h3>
<p>间接寻址模式将一个寄存器中保存的内存地址对应的值载入，例如 <code>movl (%eax), %ebx</code> 将 <code>%eax</code> 储存的内存地址的值载入<code>%ebx</code></p>
<h3 id="基指针寻址模式">基指针寻址模式</h3>
<p>基指针寻址与间接寻址模式相似，除了它向寄存器中储存的内存地址加上一个常量。例如<code>movl 4(%eax), %ebx</code></p>
<p>除此之外，我们还能操作不同大小的数据，例如<code>movb</code>可以一次移动一个字节的数据，而且我们可以使用部分寄存器。<br>
拿 <code>%eax</code> 举个例子，如果你想一次使用两个字节，那么 <code>%ax</code> 就是 <code>%eax</code> 的后半部分， <code>%ax</code> 还能再分为两个一字节大小的寄存器，前半部分叫 <code>%ah</code> ，后半部分叫 <code>%al</code>。<br>
<img src="../../themes/fluid/source/img/half_reg_demo.png" srcset="/img/loading.gif" lazyload alt="%eax寄存器的布局"><br>
使用部分的寄存器会损坏之前的数据，请小心。</p>
<h1>Chapter 4 函数</h1>
<h2 id="函数是如何工作的">函数是如何工作的</h2>
<p>函数由以下几部分组成：</p>
<ul>
<li>函数名（function name）</li>
<li>函数参数（function parameters）</li>
<li>局部变量（local variables）</li>
<li>静态变量（static variables）</li>
<li>全局变量（global variables）</li>
<li>返回地址（return address）</li>
<li>返回值（return value）</li>
</ul>
<p>不同的语言的变量储存、参数传递和返回地址传递的方式不同。这种区别就是不同的 <strong>调用约定（calling convention）</strong>。<br>
汇编语言允许你使用任何语言的调用约定，你甚至可以自己实现一个调用约定，但为了与其他语言兼容，最好采用对应的方式。<br>
这里我们介绍C语言的调用约定。</p>
<h2 id="使用C调用约定的汇编语言函数">使用C调用约定的汇编语言函数</h2>
<h3 id="栈">栈</h3>
<p>我们先要了解栈（stack）是什么。你的电脑有栈，它在内存地址的顶部。你可以用 <code>pushl</code> 向栈的顶部压入东西，也可以用 <code>popl</code> 弹出东西。虽然我们说“栈的顶部”，但是栈在内存地址的顶部，所以栈是向下增长的，新数据在栈内存地址的下面。我们可以一直往栈里压入东西，栈顶部会移动来容纳我们的数据，直到栈往下增长碰到我们的代码或其他数据。<br>
所以我们怎么知道栈的顶部在哪？<code>%esp</code> （栈寄存器）寄存器保存着指向栈顶部的指针。每次我们用 <code>pushl</code> 压入栈， <code>%esp</code> 就会减4来指向栈顶部，用 <code>popl</code> 弹出栈，它就会加4。<br>
可以使用各种寻址模式来访问栈中各种位置的数据。</p>
<h3 id="C语言函数调用约定">C语言函数调用约定</h3>
<p>C语言首先将参数反向地压入栈中，然后执行 <code>call + 函数名</code> 指令调用函数， <code>call</code> 会将返回地址压入栈顶，并修改 <code>%eip</code> 寄存器（指令指针）使其指向函数开始的指令的地址。函数刚调用时栈看起来像这样：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elm">参数<span class="hljs-type">N</span>  <br>...  <br>参数<span class="hljs-number">2</span>  <br>参数<span class="hljs-number">1</span>  <br>返回地址 &lt;-<span class="hljs-comment">--- (%esp)</span><br></code></pre></td></tr></table></figure>
<p>调用函数后，第一件事就是将原来的基指针寄存器（ <code>%ebp</code> ）压住栈中保存，并将 <code>%ebp</code> 移动到 <code>%esp</code>的位置（ <code>movl %esp, %ebp</code> ），这样无论怎么压入弹出栈，你总能通过位于函数开始位置的 <code>%ebp</code> 轻松地访问栈中各个位置。<br>
这样， <code>%esp</code> 就能自由移动，将其减去相应的字节数来创建更多的栈的空间供函数使用（比如储存局部变量）。<br>
当函数干完活了，它按下面的流程滚蛋：<br>
1.在 <code>%eax</code> 中储存返回值。<br>
2.将栈指针恢复到调用前的样子。<br>
3.使用 <code>ret</code> 指令，从栈顶获得返回地址并将 <code>%eip</code> 设定到那里。将控制权交回原程序。<br>
执行下面的指令：</p>
 <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">movl <span class="hljs-variable">%ebp</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%esp</span><br>popl <span class="hljs-variable">%ebp</span><br><span class="hljs-keyword">ret</span><br></code></pre></td></tr></table></figure>
<p>所有的局部变量都已销毁，现在可以在 <code>%eax</code> 找到返回值，若不需要调用参数，还需要把 <code>%esp</code> 加4*参数数量（ <code>addl</code> ）。<br>
注意：调用函数的时候除了 <code>%ebp</code> 会保留原来的内容，你应该假设其它寄存器都被清空了。<br>
这是一个简化了的版本，具体细节可以在<a target="_blank" rel="noopener" href="http://www.linuxbase.org/spec/refspecs/">这里</a>查询 <em>System V Application Binary Interface- Intel386 Architecture<br>
Processor Supplement</em></p>
<h3 id="一个使用函数的例子">一个使用函数的例子</h3>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs mel"># 演示计算<span class="hljs-number">2</span>^<span class="hljs-number">3</span>+<span class="hljs-number">5</span>^<span class="hljs-number">2</span><br>.section .data<br>.section .<span class="hljs-keyword">text</span><br>.<span class="hljs-keyword">global</span> _start<br><br>_start:<br> pushl $3<br> pushl $2<br> call power<br> addl $8, %esp<br><br> pushl %eax<br><br> pushl $2<br> pushl $5<br> call power<br> addl $8, %esp<br><br> popl %ebx<br> addl %eax, %ebx<br><br> movl $1, %eax<br> <span class="hljs-keyword">int</span> <span class="hljs-number">0x80</span><br><br>.type power, @function # 告知链接器 power 应被视为一个函数<br>power:<br> pushl %ebp<br> movl %esp, %ebp<br> subl $4, %esp<br> <br> movl <span class="hljs-number">8</span>(%ebp), %ebx<br> movl <span class="hljs-number">12</span>(%ebp), %ecx<br><br> movl %ebx, <span class="hljs-number">-4</span>(%ebp)<br><br>power_loop_start:<br> cmpl $1, %ecx<br> je end_power<br> movl <span class="hljs-number">-4</span>(%ebp), %eax<br> imull %ebx, %eax<br> movl %eax, <span class="hljs-number">-4</span>(%ebp)<br> decl %ecx<br> jmp power_loop_start<br><br>end_power:<br> movl <span class="hljs-number">-4</span>(%ebp), %eax<br> movl %ebp, %esp<br> popl %ebp<br> ret<br></code></pre></td></tr></table></figure>
<h3 id="递归函数">递归函数</h3>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs mel"># 此程序计算<span class="hljs-number">4</span>的阶乘<br>.section .data<br>.section .<span class="hljs-keyword">text</span><br>.<span class="hljs-keyword">global</span> _start<br>.<span class="hljs-keyword">global</span> factorial<br>_start:<br> pushl $4<br> call factorial<br> addl $4, %esp<br> movl %eax, %ebx<br> movl $1, %eax<br> <span class="hljs-keyword">int</span> <span class="hljs-number">0x80</span><br>factorial:<br> pushl %ebp<br> movl %esp, %ebp<br> movl <span class="hljs-number">8</span>(%ebp), %eax<br> cmpl $1, %eax<br> je end_factorial<br> decl %eax<br> pushl %eax<br> call factorial<br> movl <span class="hljs-number">8</span>(%ebp), %ebx<br> imull %ebx, %eax<br>end_factorial:<br> movl %ebp, %esp<br> popl %ebp<br> ret<br></code></pre></td></tr></table></figure>
<h1>Chapter Final(?)</h1>
<p>如你所见，这篇笔记到末尾了。这里面肯定还有错误，希望广大读者能指出，鄙人不才，献丑了。<br>
汇编是一种看起来简单但使用起来极其复杂的底层语言，在高级语言流行的时代，我们不能粗暴的忽视汇编，相反，接触一些汇编知识会让我们对计算机架构和高级语言的指针有更深刻的理解，也为逆向和信息安全领域打下一些基础。<br>
<em>Programming from the Ground Up</em> 这本书还有内容，由于笔者精力和个人安排，笔记就记录到这，后面可能会更新一点第五章的内容。<br>
E.O.F.</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/10/28/%E6%9C%80%E5%A4%A7%E5%85%AC%E7%BA%A6%E6%95%B0%E4%B8%8E%E6%9C%80%E5%B0%8F%E5%85%AC%E5%80%8D%E6%95%B0/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">最大公约数与最小公倍数</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/08/25/Android-%E8%B0%83%E8%AF%95%E5%B0%8F%E8%AF%BE%E5%A0%82/">
                        <span class="hidden-mobile">Android 调试小课堂</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.4/es5/tex-svg.js" ></script>

  








  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-205458257-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
